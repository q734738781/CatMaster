# CatMaster 环境配置指南

## 总览

CatMaster 使用 jobflow-remote 架构，运行模式如下：

- **PC 控制端**：运行 jobflow-remote runner，通过 MongoDB 管理作业队列，通过 SSH/SFTP 连接到远程服务器
- **CPU 集群**：被动接收来自 PC runner 的 Slurm 作业提交
- **GPU 服务器**：被动接收来自 PC runner 的本地执行任务

**重要**：Runner **仅在 PC 端运行**，通过 SSH 自动连接到远程服务器执行任务并传输文件。

---

## PC 控制端环境

### 安装依赖

```bash
# 创建 Python 环境
conda create -n catmaster python=3.12 && conda activate catmaster

# 安装依赖
pip install -r requirements/pc.txt
```

依赖包括：
- `jobflow>=0.1.5`
- `jobflow-remote>=0.1.8`
- `pymatgen>=2024.2.23`
- `ase>=3.23.0`
- `paramiko>=3.3.0`（SSH 连接）
- `mp-api>=0.40.0`

### 配置 SSH 免密登录

```bash
# 生成 SSH 密钥（如果还没有）
ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519

# 复制公钥到 CPU 集群
ssh-copy-id -i ~/.ssh/id_ed25519.pub chenhh@166.111.35.183 -p 31125

# 复制公钥到 GPU 服务器
ssh-copy-id -i ~/.ssh/id_ed25519.pub chenhh@166.111.35.177

# 测试免密登录
ssh -p 31125 chenhh@166.111.35.183
ssh chenhh@166.111.35.177
```

### 配置环境变量

```bash
# 创建环境文件
cp configs/environment.example.sh ~/.catmaster_env.sh
chmod 600 ~/.catmaster_env.sh

# 编辑并添加：
# - MongoDB 连接
# - Materials Project API key
# - 默认项目和 worker 名称

# 加载环境
source ~/.catmaster_env.sh
```

### 配置 MongoDB

```bash
# 本地开发可使用 Docker
docker run -d -p 27017:27017 --name catmaster-mongo mongo:6.0

# 生产环境建议使用 MongoDB Atlas 或独立实例
```

## Jobflow-Remote 配置

### 初始化

```bash
# PC 端初始化
jfr settings init

# 复制配置模板
cp configs/jobflow_remote/projects/catmaster_demo.yaml ~/.jobflow_remote/projects/

# 编辑配置
nano ~/.jobflow_remote/projects/catmaster_demo.yaml
```

### 配置要点

在 `catmaster_demo.yaml` 中配置：

1. **MongoDB 连接**（PC 能访问即可）
2. **SSH 连接信息**（CPU 集群和 GPU 服务器）
3. **远程路径**（工作目录、Python 环境）
4. **资源配置**（Slurm 参数、GPU 资源）

**关键**：`type: remote` 表示 runner 会通过 SSH 连接到这些服务器

---

## 启动 Runner（仅在 PC 端）

```bash
# 在 PC 端启动 runner
# 前台运行（测试用）
jfr runner start -p catmaster-demo

# 后台运行（生产用）
jfr runner daemon -p catmaster-demo start

# 查看 runner 状态
jfr runner status -p catmaster-demo

# 停止 runner
jfr runner daemon -p catmaster-demo stop
```

**注意**：
- Runner **只在 PC 端运行**
- Runner 会自动通过 SSH 连接到 CPU/GPU 服务器
- 文件通过 SFTP 自动传输
- 不需要在远程服务器上运行 runner

---

## 文件传输机制

jobflow-remote 自动处理文件传输：

1. **小文件（< 16MB）**：通过 MongoDB GridFS 存储和传输
2. **大文件**：通过 SFTP 传输到远程 `work_dir`
3. **结果文件**：执行完成后自动传回 PC

配置中的 `transfer_files: true` 启用自动传输：
```yaml
runner:
  transfer_files: true  # SFTP 自动传输
```

---

## 快速部署步骤

### 1. 准备环境

**PC 端：**
```bash
conda create -n catmaster python=3.12
pip install -r requirements/pc.txt
source ~/.catmaster_env.sh
```

**CPU 集群：**
```bash
ssh -p 31125 chenhh2@166.111.35.183
pip install -r requirements/cpu.txt
export VASP_STD_BIN=/path/to/vasp_std
export VASP_PP_PATH=/path/to/potpaw
```

**GPU 服务器：**
```bash
ssh chenhh@166.111.35.177
pip install -r requirements/gpu.txt
pip install torch --index-url https://download.pytorch.org/whl/cu118
```

### 2. 配置 jobflow-remote（PC 端）

```bash
jfr settings init
cp configs/jobflow_remote/projects/catmaster_demo.yaml ~/.jobflow_remote/projects/
# 编辑配置文件，更新 MongoDB 和 SSH 路径
```

### 3. 启动 Runner（PC 端）

```bash
jfr runner daemon -p catmaster-demo start
```

### 4. 提交作业（PC 端）

```bash
# VASP 计算
python demo_scripts/run_cpu_jobflow_demo.py \
  --structure demo_scripts/assets/POSCAR_O2_BOX \
  --project catmaster-demo \
  --worker slurm-cpu \
  --relax

# MACE 计算
python demo_scripts/run_gpu_jobflow_demo.py \
  --structure demo_scripts/assets/POSCAR_O2_BOX \
  --project catmaster-demo \
  --worker local-gpu \
  --task-type relax
```

### 5. 监控作业（PC 端）

```bash
# 查看所有作业
jfr job list -p catmaster-demo

# 查看特定作业状态
jfr job status <job_id> -p catmaster-demo

# 查看作业详细信息
jfr job info <job_id> -p catmaster-demo
```

---

## 工作流程

1. **PC 端提交**：`submit_flow()` → 作业信息存入 MongoDB
2. **PC runner 轮询**：检查 MongoDB 发现新作业
3. **SSH 连接**：Runner 通过 SSH 连接到目标服务器
4. **文件传输**：通过 SFTP 传输输入文件
5. **执行作业**：
   - CPU：通过 SSH 提交 Slurm 作业
   - GPU：通过 SSH 直接执行
6. **结果传回**：通过 SFTP 获取输出文件
7. **更新状态**：结果存入 MongoDB
8. **PC 查询**：从 MongoDB 获取结果

---

## 故障排查

### SSH 连接问题
```bash
# 测试 SSH 连接
ssh -p 31125 chenhh2@166.111.35.183
ssh chenhh@166.111.35.177

# 检查免密登录
ssh -v -p 31125 chenhh2@166.111.35.183
```

### MongoDB 连接
```bash
# 测试连接
python -c "from pymongo import MongoClient; print(MongoClient('mongodb://localhost:27017/').server_info())"
```

### Runner 日志
```bash
# 查看 runner 日志
jfr runner logs -p catmaster-demo
```

### 作业失败
```bash
# 查看作业错误
jfr job info <job_id> -p catmaster-demo

# 重新运行失败的作业
jfr job rerun <job_id> -p catmaster-demo
```

---

## Phase 1 功能总结

### VASP 计算（CPU）
- PC runner 通过 SSH 提交到 Slurm
- 支持 MPRelaxSet + 自定义 INCAR
- O2 分子松弛：ISIF=2, 1x1x1 K-point
- 文件通过 SFTP 自动传输

### MACE 计算（GPU）
- PC runner 通过 SSH 在 GPU 服务器执行
- MACE-MP 预训练模型
- 自动 GPU 选择（NVML）
- 结构松弛 + 全局搜索 + Minima Hopping

### 核心优势
- 标准 jobflow 模式，无自定义抽象层
- Runner 仅在 PC 运行，简化部署
- 自动文件传输（SFTP）
- 通过 MongoDB 队列管理